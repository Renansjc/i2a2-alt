# agents/config/tasks.yaml
# Configura√ß√£o das tarefas para o sistema multi-agente de NF-e

analyze_intent:
  description: >
    Analise a mensagem do usu√°rio: "{message}"
    
    Contexto da conversa: {chat_history}
    
    Determine se a mensagem requer:
    1. **database_query** - Consulta ao banco de dados
    2. **conversation_only** - Resposta conversacional
    
    REQUER DATABASE_QUERY quando pergunta sobre:
    ‚úì Valores, quantidades, totais (Ex: "quanto vendemos?", "qual o valor total?")
    ‚úì Datas espec√≠ficas (Ex: "vendas de janeiro", "notas de hoje")
    ‚úì Empresas/clientes (Ex: "notas da empresa X", "maiores clientes")
    ‚úì Produtos (Ex: "produtos mais vendidos", "quais itens foram vendidos")
    ‚úì Impostos (Ex: "total de ICMS", "quanto pagamos de PIS")
    ‚úì Estat√≠sticas (Ex: "m√©dia de vendas", "top 10 produtos")
    ‚úì Compara√ß√µes (Ex: "vendas este m√™s vs m√™s passado")
    
    REQUER CONVERSATION_ONLY quando:
    ‚úì Sauda√ß√µes (Ex: "ol√°", "bom dia", "oi")
    ‚úì Agradecimentos (Ex: "obrigado", "valeu")
    ‚úì Perguntas sobre o sistema (Ex: "o que voc√™ pode fazer?", "como funciona?")
    ‚úì Explica√ß√µes gerais (Ex: "o que √© NF-e?", "como importar notas?")
    ‚úì Confirma√ß√µes (Ex: "ok", "entendi", "certo")
    
    EXEMPLOS:
    - "Quanto vendemos em janeiro?" ‚Üí database_query
    - "Quais s√£o os 5 produtos mais vendidos?" ‚Üí database_query
    - "Ol√°, tudo bem?" ‚Üí conversation_only
    - "O que √© uma nota fiscal eletr√¥nica?" ‚Üí conversation_only
  
  expected_output: >
    JSON com:
    {
      "strategy": "database_query" ou "conversation_only",
      "confidence": "high" ou "medium" ou "low",
      "reasoning": "breve justificativa (1-2 frases)",
      "detected_entities": {
        "time_period": "se houver refer√™ncia a per√≠odo",
        "companies": ["se houver men√ß√£o a empresas"],
        "products": ["se houver men√ß√£o a produtos"],
        "metrics": ["valores mencionados: total, m√©dia, quantidade, etc"]
      }
    }
  
  agent: coordinator

execute_sql_query:
  description: >
    Execute uma consulta SQL para responder: "{message}"
    
    Schema dispon√≠vel:
    {database_schema}
    
    Entidades detectadas: {detected_entities}
    Contexto: {chat_history}
    
    PROCESSO OBRIGAT√ìRIO:
    
    1. AN√ÅLISE DA PERGUNTA
       - Identifique o objetivo (total? lista? compara√ß√£o? m√©dia?)
       - Identifique filtros (per√≠odo, empresa, produto, status)
       - Identifique agrega√ß√µes necess√°rias (SUM, COUNT, AVG, etc)
    
    2. SELE√á√ÉO DE TABELAS
       - notas_fiscais: para dados gerais da NF
       - empresas: para emitentes/destinat√°rios
       - nf_itens: para produtos/servi√ßos
       - nf_itens_icms/ipi/pis/cofins: para impostos
       - nf_pagamentos: para formas de pagamento
    
    3. CONSTRU√á√ÉO DA QUERY
       - Use SELECT com colunas espec√≠ficas (nunca SELECT *)
       - Use JOINs apropriados (INNER para obrigat√≥rio, LEFT para opcional)
       - Adicione WHERE com filtros relevantes
       - SEMPRE filtre status='autorizada' (notas v√°lidas)
       - Use GROUP BY para agrega√ß√µes
       - Use ORDER BY para ordena√ß√£o l√≥gica
       - SEMPRE adicione LIMIT (m√°x 100)
    
    4. VALIDA√á√ÉO
       - Apenas SELECT permitido (nunca INSERT/UPDATE/DELETE)
       - Sintaxe PostgreSQL v√°lida
       - Aliases descritivos nas colunas
       - Valores monet√°rios como NUMERIC
    
    5. FORMATA√á√ÉO
       - Use TO_CHAR para formatar datas
       - Use ROUND para valores monet√°rios (2 casas)
       - Use aliases leg√≠veis (total_vendas, quantidade_produtos, etc)
    
    EXEMPLOS DE QUERIES BEM FEITAS:
    
    Pergunta: "Quanto vendemos este m√™s?"
    ```sql
    SELECT 
      COUNT(*) as total_notas,
      ROUND(SUM(valor_total_nota)::numeric, 2) as valor_total,
      ROUND(AVG(valor_total_nota)::numeric, 2) as valor_medio
    FROM notas_fiscais
    WHERE status = 'autorizada'
      AND DATE_TRUNC('month', data_hora_emissao) = DATE_TRUNC('month', CURRENT_DATE)
    LIMIT 1;
    ```
    
    Pergunta: "Top 5 produtos mais vendidos"
    ```sql
    SELECT 
      i.descricao as produto,
      SUM(i.quantidade_comercial) as quantidade_total,
      ROUND(SUM(i.valor_total_bruto)::numeric, 2) as valor_total
    FROM nf_itens i
    INNER JOIN notas_fiscais nf ON i.nota_fiscal_id = nf.id
    WHERE nf.status = 'autorizada'
    GROUP BY i.descricao
    ORDER BY quantidade_total DESC
    LIMIT 5;
    ```
    
    Pergunta: "Notas da empresa ABC"
    ```sql
    SELECT 
      nf.numero_nf,
      nf.serie,
      TO_CHAR(nf.data_hora_emissao, 'DD/MM/YYYY') as data_emissao,
      ROUND(nf.valor_total_nota::numeric, 2) as valor_total,
      e.razao_social as emitente
    FROM notas_fiscais nf
    LEFT JOIN empresas e ON nf.emitente_id = e.id
    WHERE nf.status = 'autorizada'
      AND e.razao_social ILIKE '%ABC%'
    ORDER BY nf.data_hora_emissao DESC
    LIMIT 20;
    ```
  
  expected_output: >
    JSON estruturado:
    {
      "query": "SQL query executada (para auditoria)",
      "results": [array de objetos com os dados],
      "row_count": n√∫mero de registros retornados,
      "summary": "resumo breve (ex: 'Encontradas 5 notas totalizando R$ 10.000')",
      "execution_time_ms": tempo de execu√ß√£o em milissegundos,
      "columns": ["lista de colunas retornadas"]
    }
  
  agent: sql_specialist

format_response:
  description: >
    Formate os dados em uma resposta natural e profissional:
    
    Dados da consulta: {query_results}
    Mensagem original: "{message}"
    Contexto: {chat_history}
    
    DIRETRIZES DE FORMATA√á√ÉO:
    
    1. ESTRUTURA DA RESPOSTA
       ‚úì Comece respondendo diretamente √† pergunta
       ‚úì Apresente os principais dados/destaques
       ‚úì Forne√ßa detalhes adicionais se relevante
       ‚úì Conclua com oferta de ajuda adicional
    
    2. FORMATA√á√ÉO DE VALORES
       ‚úì Monet√°rios: R$ 1.234,56 (com separadores)
       ‚úì Grandes n√∫meros: 1.234 (separador de milhares)
       ‚úì Percentuais: 15,5% (uma casa decimal)
       ‚úì Datas: 27/10/2025 ou "outubro de 2025"
    
    3. ORGANIZA√á√ÉO VISUAL
       ‚úì Use listas numeradas para rankings
       ‚úì Use bullet points para itens n√£o ordenados
       ‚úì Use negrito para destacar valores importantes (quando suportado)
       ‚úì Separe se√ß√µes com quebras de linha
    
    4. TOM E ESTILO
       ‚úì Profissional mas acess√≠vel
       ‚úì Conciso mas completo
       ‚úì Use contexto da conversa para personalizar
       ‚úì Evite jarg√£o t√©cnico desnecess√°rio
    
    5. CONTEXTUALIZA√á√ÉO
       ‚úì Compare com per√≠odos anteriores quando relevante
       ‚úì Destaque tend√™ncias ou padr√µes
       ‚úì Adicione insights quando apropriado
       ‚úì Sugira an√°lises complementares
    
    EXEMPLOS DE BOAS RESPOSTAS:
    
    Para query de vendas mensais:
    ```
    Em outubro de 2025, foram emitidas 45 notas fiscais totalizando R$ 125.430,50.
    
    Isso representa:
    ‚Ä¢ Valor m√©dio por nota: R$ 2.787,34
    ‚Ä¢ 15% a mais que setembro
    ‚Ä¢ Maior volume do trimestre
    
    Gostaria de ver o detalhamento por produto ou por cliente?
    ```
    
    Para ranking de produtos:
    ```
    Os 5 produtos mais vendidos em outubro foram:
    
    1. **Produto A** - 234 unidades (R$ 45.600,00)
    2. **Produto B** - 189 unidades (R$ 32.150,00)
    3. **Produto C** - 156 unidades (R$ 28.900,00)
    4. **Produto D** - 142 unidades (R$ 25.340,00)
    5. **Produto E** - 138 unidades (R$ 23.780,00)
    
    Total: 859 unidades vendidas, R$ 155.770,00 em receita.
    
    Posso detalhar algum produto espec√≠fico?
    ```
    
    Para dados de empresa:
    ```
    Encontrei 12 notas fiscais da empresa ABC Com√©rcio Ltda:
    
    ‚Ä¢ Per√≠odo: Janeiro a Outubro 2025
    ‚Ä¢ Valor total: R$ 87.450,00
    ‚Ä¢ Ticket m√©dio: R$ 7.287,50
    ‚Ä¢ √öltima nota: 15/10/2025
    
    A empresa representa 8% do seu faturamento total no per√≠odo.
    
    Quer ver as notas mais recentes ou analisar os produtos comprados?
    ```
  
  expected_output: >
    Resposta em linguagem natural que:
    - Responde diretamente √† pergunta do usu√°rio
    - Formata valores corretamente (R$, %, datas)
    - Organiza informa√ß√£o de forma clara e escane√°vel
    - Adiciona contexto e insights relevantes
    - Mant√©m tom profissional e prestativo
    - Oferece pr√≥ximos passos ou perguntas de aprofundamento
  
  agent: conversation_specialist

direct_conversation:
  description: >
    Responda √† mensagem do usu√°rio: "{message}"
    
    Contexto: {chat_history}
    
    Esta √© uma intera√ß√£o conversacional sem consulta ao banco.
    
    TIPOS DE INTERA√á√ÉO:
    
    1. SAUDA√á√ïES
       - Responda de forma amig√°vel e profissional
       - Apresente brevemente suas capacidades
       - Ofere√ßa exemplos de perguntas
    
    2. AGRADECIMENTOS
       - Reconhe√ßa o agradecimento
       - Ofere√ßa ajuda adicional
       - Mantenha a conversa aberta
    
    3. PERGUNTAS SOBRE O SISTEMA
       - Explique funcionalidades de forma clara
       - D√™ exemplos pr√°ticos
       - Direcione para pr√≥ximas a√ß√µes
    
    4. EXPLICA√á√ïES DE CONCEITOS
       - Explique de forma acess√≠vel
       - Use analogias quando apropriado
       - Ofere√ßa informa√ß√µes complementares
    
    5. CONFIRMA√á√ïES
       - Confirme entendimento
       - Pergunte se precisa de mais detalhes
       - Sugira pr√≥ximos passos
    
    INFORMA√á√ïES DO SISTEMA (use quando relevante):
    
    CAPACIDADES:
    ‚Ä¢ An√°lise de notas fiscais eletr√¥nicas (NF-e)
    ‚Ä¢ Consultas sobre vendas, produtos, clientes
    ‚Ä¢ C√°lculos de impostos (ICMS, IPI, PIS, COFINS)
    ‚Ä¢ Estat√≠sticas e relat√≥rios personalizados
    ‚Ä¢ Compara√ß√µes entre per√≠odos
    ‚Ä¢ Rankings e top listas
    
    EXEMPLOS DE PERGUNTAS:
    ‚Ä¢ "Quanto vendemos este m√™s?"
    ‚Ä¢ "Quais s√£o os produtos mais vendidos?"
    ‚Ä¢ "Mostre as notas da empresa XYZ"
    ‚Ä¢ "Qual o total de ICMS pago em outubro?"
    ‚Ä¢ "Compare as vendas de setembro e outubro"
    
    ESTRUTURA DO BANCO:
    ‚Ä¢ Notas fiscais completas (emitente, destinat√°rio, valores)
    ‚Ä¢ Itens detalhados (produtos, quantidades, valores)
    ‚Ä¢ Impostos discriminados (ICMS, IPI, PIS, COFINS)
    ‚Ä¢ Formas de pagamento
    ‚Ä¢ Dados de transporte
    
    TECNOLOGIA:
    ‚Ä¢ Sistema multi-agente com CrewAI
    ‚Ä¢ Banco PostgreSQL (Supabase)
    ‚Ä¢ Processamento inteligente de linguagem natural
    ‚Ä¢ Consultas SQL otimizadas e seguras
    
    EXEMPLOS DE BOAS RESPOSTAS:
    
    Para "Ol√°":
    ```
    Ol√°! üëã Sou seu assistente de an√°lise de notas fiscais eletr√¥nicas.
    
    Posso ajud√°-lo a:
    ‚Ä¢ Consultar vendas e faturamento
    ‚Ä¢ Analisar produtos e clientes
    ‚Ä¢ Verificar impostos e pagamentos
    ‚Ä¢ Gerar relat√≥rios personalizados
    
    Por exemplo, voc√™ pode perguntar:
    "Quanto vendemos este m√™s?" ou "Quais os produtos mais vendidos?"
    
    Como posso ajudar voc√™ hoje?
    ```
    
    Para "O que √© NF-e?":
    ```
    NF-e (Nota Fiscal Eletr√¥nica) √© um documento fiscal digital que substitui
    a nota fiscal em papel. Ela cont√©m todas as informa√ß√µes da opera√ß√£o comercial:
    
    ‚Ä¢ Dados do emitente e destinat√°rio
    ‚Ä¢ Produtos ou servi√ßos vendidos
    ‚Ä¢ Valores e impostos (ICMS, IPI, PIS, COFINS)
    ‚Ä¢ Forma de pagamento e transporte
    
    O sistema armazena todas essas informa√ß√µes e permite consultas detalhadas.
    
    Gostaria de ver exemplos de consultas que posso fazer?
    ```
    
    Para "Obrigado":
    ```
    Por nada! üòä Fico feliz em ajudar.
    
    Se precisar de mais an√°lises ou tiver outras d√∫vidas sobre suas notas
    fiscais, estou aqui.
    
    At√© logo!
    ```
  
  expected_output: >
    Resposta conversacional que:
    - Mant√©m tom amig√°vel e profissional
    - Fornece informa√ß√µes √∫teis e relevantes
    - Usa o contexto da conversa
    - Oferece exemplos pr√°ticos quando apropriado
    - Encoraja continua√ß√£o da conversa
    - √â concisa mas completa
  
  agent: conversation_specialist
