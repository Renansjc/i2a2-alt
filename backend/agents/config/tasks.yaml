# agents/config/tasks.yaml
# Configuração OTIMIZADA das tarefas para o sistema multi-agente de NF-e

analyze_intent:
  description: >
    Analise a mensagem do usuário: "{message}"
    
    Contexto da conversa: {chat_history}
    
    ⚠️ PRIORIDADE: Verifique se é FOLLOW-UP antes de classificar!
    
    FOLLOW-UP (usa contexto, não precisa de banco):
    ✓ Perguntas que se referem a algo já mencionado
    ✓ Palavras-chave: "qual foi", "quanto foi", "e o/a", "aquele", "esse", "anterior"
    ✓ Exemplos: "Qual foi o nome?", "E a empresa?", "Quanto foi mesmo?"
    → Classificar como: **conversation_only** (usará contexto)
    
    DATABASE_QUERY (precisa consultar banco):
    ✓ Valores, quantidades, totais NOVOS (Ex: "quanto vendemos?", "qual o valor total?")
    ✓ Datas específicas (Ex: "vendas de janeiro", "notas de hoje")
    ✓ Empresas/clientes (Ex: "notas da empresa X", "maiores clientes")
    ✓ Produtos (Ex: "produtos mais vendidos", "quais itens foram vendidos")
    ✓ Impostos (Ex: "total de ICMS", "quanto pagamos de PIS")
    ✓ Estatísticas (Ex: "média de vendas", "top 10 produtos")
    ✓ Comparações (Ex: "vendas este mês vs mês passado")
    
    CONVERSATION_ONLY (resposta direta sem banco):
    ✓ Saudações (Ex: "olá", "bom dia", "oi")
    ✓ Agradecimentos (Ex: "obrigado", "valeu")
    ✓ Perguntas sobre o sistema (Ex: "o que você pode fazer?", "como funciona?")
    ✓ Explicações gerais (Ex: "o que é NF-e?", "como importar notas?")
    ✓ Confirmações (Ex: "ok", "entendi", "certo")
    ✓ FOLLOW-UPS (perguntas sobre resposta anterior)
    
    EXEMPLOS:
    - "Quanto vendemos em janeiro?" → database_query
    - "Qual foi o valor mesmo?" → conversation_only (follow-up)
    - "Quais os 5 produtos mais vendidos?" → database_query
    - "E o nome da empresa?" → conversation_only (follow-up)
    - "Olá, tudo bem?" → conversation_only
  
  expected_output: >
    JSON com:
    {
      "strategy": "database_query" ou "conversation_only",
      "confidence": "high" ou "medium" ou "low",
      "is_follow_up": true/false,
      "reasoning": "breve justificativa (1-2 frases)",
      "detected_entities": {
        "time_period": "se houver referência a período",
        "companies": ["se houver menção a empresas"],
        "products": ["se houver menção a produtos"],
        "metrics": ["valores mencionados: total, média, quantidade, etc"]
      }
    }
  
  agent: coordenador

execute_sql_query:
  description: >
    ⚠️ ATENÇÃO: Antes de executar query, verifique se a informação JÁ está no contexto!
    
    Contexto disponível: {chat_history}
    
    Se a resposta está no contexto acima, NÃO execute query - responda usando o contexto.
    
    ════════════════════════════════════════════════════════════════
    
    Execute uma consulta SQL para responder: "{message}"
    
    Schema disponível: {database_schema}
    
    Entidades detectadas: {detected_entities}
    
    PROCESSO OBRIGATÓRIO:
    
    1. VERIFICAR CONTEXTO PRIMEIRO
       - Se a informação JÁ foi consultada, está no contexto acima
       - NÃO execute a mesma query novamente
       - Use o resultado anterior do contexto
    
    2. ANÁLISE DA PERGUNTA (se precisar de query nova)
       - Identifique o objetivo (total? lista? comparação? média?)
       - Identifique filtros (período, empresa, produto, status)
       - Identifique agregações necessárias (SUM, COUNT, AVG, etc)
    
    3. SELEÇÃO DE TABELAS
       - notas_fiscais: para dados gerais da NF
       - empresas: para emitentes/destinatários
       - nf_itens: para produtos/serviços
       - nf_itens_icms/ipi/pis/cofins: para impostos
       - nf_pagamentos: para formas de pagamento
    
    4. CONSTRUÇÃO DA QUERY
       - Use SELECT com colunas específicas (nunca SELECT *)
       - Use JOINs apropriados (INNER para obrigatório, LEFT para opcional)
       - Adicione WHERE com filtros relevantes
       - SEMPRE filtre status='autorizada' (notas válidas)
       - Use GROUP BY para agregações
       - Use ORDER BY para ordenação lógica
       - SEMPRE adicione LIMIT (máx 100)
    
    5. VALIDAÇÃO
       - Apenas SELECT permitido (nunca INSERT/UPDATE/DELETE)
       - Sintaxe PostgreSQL válida
       - Aliases descritivos nas colunas
       - Valores monetários como NUMERIC
    
    6. FORMATAÇÃO
       - Use TO_CHAR para formatar datas
       - Use ROUND para valores monetários (2 casas)
       - Use aliases legíveis (total_vendas, quantidade_produtos, etc)
    
    ⚠️ REGRAS ANTI-LOOP:
    - Máximo 2 tentativas por query
    - Se query falhar, NÃO tente exatamente igual
    - Se falhar 2x, responda com o que conseguiu
    - NUNCA execute a mesma query que está no contexto
    
    EXEMPLOS DE QUERIES BEM FEITAS:
    
    Pergunta: "Quanto vendemos este mês?"
    ```sql
    SELECT 
      COUNT(*) as total_notas,
      ROUND(SUM(valor_total_nota)::numeric, 2) as valor_total,
      ROUND(AVG(valor_total_nota)::numeric, 2) as valor_medio
    FROM notas_fiscais
    WHERE status = 'autorizada'
      AND DATE_TRUNC('month', data_hora_emissao) = DATE_TRUNC('month', CURRENT_DATE)
    LIMIT 1;
    ```
    
    Pergunta: "Top 5 produtos mais vendidos"
    ```sql
    SELECT 
      i.descricao_produto as produto,
      SUM(i.quantidade_comercial) as quantidade_total,
      ROUND(SUM(i.valor_total_bruto)::numeric, 2) as valor_total
    FROM nf_itens i
    INNER JOIN notas_fiscais nf ON i.nota_fiscal_id = nf.id
    WHERE nf.status = 'autorizada'
    GROUP BY i.descricao_produto
    ORDER BY quantidade_total DESC
    LIMIT 5;
    ```
    
    Pergunta: "Gere empresa aleatória"
    ```sql
    SELECT 
      id,
      razao_social,
      cpf_cnpj,
      nome_fantasia
    FROM empresas
    ORDER BY RANDOM()
    LIMIT 1;
    ```
  
  expected_output: >
    JSON estruturado:
    {
      "query": "SQL query executada (para auditoria)",
      "results": [array de objetos com os dados],
      "row_count": número de registros retornados,
      "summary": "resumo breve (ex: 'Encontradas 5 notas totalizando R$ 10.000')",
      "execution_time_ms": tempo de execução em milissegundos,
      "columns": ["lista de colunas retornadas"]
    }
  
  agent: sql_specialist

format_response:
  description: >
    ⚠️ IMPORTANTE: Verifique o contexto ANTES de formatar!
    
    Contexto da conversa: {chat_history}
    
    Se o usuário perguntou sobre algo JÁ mencionado (follow-up):
    → Use informação do CONTEXTO, não dos dados da consulta
    
    ════════════════════════════════════════════════════════════════
    
    Formate os dados em uma resposta natural e profissional:
    
    Dados da consulta: {query_results}
    Mensagem original: "{message}"
    
    DIRETRIZES DE FORMATAÇÃO:
    
    1. ESTRUTURA DA RESPOSTA
       ✓ Comece respondendo diretamente à pergunta
       ✓ Apresente os principais dados/destaques
       ✓ Forneça detalhes adicionais se relevante
       ✓ Conclua com oferta de ajuda adicional
    
    2. FORMATAÇÃO DE VALORES
       ✓ Monetários: R$ 1.234,56 (com separadores)
       ✓ Grandes números: 1.234 (separador de milhares)
       ✓ Percentuais: 15,5% (uma casa decimal)
       ✓ Datas: 27/10/2025 ou "outubro de 2025"
    
    3. ORGANIZAÇÃO VISUAL
       ✓ Use listas numeradas para rankings
       ✓ Use bullet points para itens não ordenados
       ✓ Use negrito para destacar valores importantes
       ✓ Separe seções com quebras de linha
    
    4. TOM E ESTILO
       ✓ Profissional mas acessível
       ✓ Conciso mas completo
       ✓ Use contexto da conversa para personalizar
       ✓ Evite jargão técnico desnecessário
    
    5. CONTEXTUALIZAÇÃO
       ✓ Compare com períodos anteriores quando relevante
       ✓ Destaque tendências ou padrões
       ✓ Adicione insights quando apropriado
       ✓ Sugira análises complementares
    
    EXEMPLOS DE BOAS RESPOSTAS:
    
    Para query de vendas mensais:
    ```
    Em outubro de 2025, foram emitidas 45 notas fiscais totalizando R$ 125.430,50.
    
    Isso representa:
    • Valor médio por nota: R$ 2.787,34
    • 15% a mais que setembro
    • Maior volume do trimestre
    
    Gostaria de ver o detalhamento por produto ou por cliente?
    ```
    
    Para ranking de produtos:
    ```
    Os 5 produtos mais vendidos em outubro foram:
    
    1. Produto A - 234 unidades (R$ 45.600,00)
    2. Produto B - 189 unidades (R$ 32.150,00)
    3. Produto C - 156 unidades (R$ 28.900,00)
    4. Produto D - 142 unidades (R$ 25.340,00)
    5. Produto E - 138 unidades (R$ 23.780,00)
    
    Total: 859 unidades vendidas, R$ 155.770,00 em receita.
    
    Posso detalhar algum produto específico?
    ```
    
    Para empresa aleatória:
    ```
    A empresa selecionada foi:
    
    Nome: [Razão Social]
    CNPJ: [XX.XXX.XXX/XXXX-XX]
    Nome Fantasia: [Se houver]
    
    Quer ver as notas fiscais dessa empresa?
    ```
    
    Para follow-up "Qual foi o nome?":
    ```
    [Buscar no contexto o nome da empresa mencionada]
    
    A empresa era [Nome da Empresa].
    
    Posso buscar mais informações sobre ela?
    ```
  
  expected_output: >
    Resposta em linguagem natural que:
    - Responde diretamente à pergunta do usuário
    - Usa contexto quando é follow-up
    - Formata valores corretamente (R$, %, datas)
    - Organiza informação de forma clara
    - Adiciona contexto e insights relevantes
    - Mantém tom profissional e prestativo
    - Oferece próximos passos
  
  agent: conversation_specialist

direct_conversation:
  description: >
    ⚠️ ESTA TASK É PARA FOLLOW-UPS E CONVERSAÇÃO!
    
    Contexto completo da conversa: {chat_history}
    
    Mensagem do usuário: "{message}"
    
    ════════════════════════════════════════════════════════════════
    INSTRUÇÕES:
    ════════════════════════════════════════════════════════════════
    
    1. SE É FOLLOW-UP (refere-se a resposta anterior):
       → Busque informação no CONTEXTO acima
       → NÃO invente informações
       → Cite o que foi mencionado anteriormente
       
       Exemplos:
       - "Qual foi o nome?" → Buscar empresa/nome no contexto
       - "Quanto foi mesmo?" → Buscar valor no contexto
       - "E a empresa?" → Buscar empresa mencionada
    
    2. SE É CONVERSAÇÃO GERAL:
       → Responda de forma amigável
       → Use as diretrizes abaixo
    
    ════════════════════════════════════════════════════════════════
    
    TIPOS DE INTERAÇÃO:
    
    1. SAUDAÇÕES
       - Responda de forma amigável e profissional
       - Apresente brevemente suas capacidades
       - Ofereça exemplos de perguntas
    
    2. AGRADECIMENTOS
       - Reconheça o agradecimento
       - Ofereça ajuda adicional
       - Mantenha a conversa aberta
    
    3. PERGUNTAS SOBRE O SISTEMA
       - Explique funcionalidades de forma clara
       - Dê exemplos práticos
       - Direcione para próximas ações
    
    4. EXPLICAÇÕES DE CONCEITOS
       - Explique de forma acessível
       - Use analogias quando apropriado
       - Ofereça informações complementares
    
    5. CONFIRMAÇÕES
       - Confirme entendimento
       - Pergunte se precisa de mais detalhes
       - Sugira próximos passos
    
    6. FOLLOW-UPS ⭐ NOVO
       - Busque no contexto acima
       - Cite informação mencionada antes
       - Ofereça aprofundar o tópico
    
    INFORMAÇÕES DO SISTEMA:
    
    CAPACIDADES:
    • Análise de notas fiscais eletrônicas (NF-e)
    • Consultas sobre vendas, produtos, clientes
    • Cálculos de impostos (ICMS, IPI, PIS, COFINS)
    • Estatísticas e relatórios personalizados
    • Comparações entre períodos
    • Rankings e top listas
    
    EXEMPLOS DE PERGUNTAS:
    • "Quanto vendemos este mês?"
    • "Quais são os produtos mais vendidos?"
    • "Mostre as notas da empresa XYZ"
    • "Qual o total de ICMS pago em outubro?"
    • "Gere uma empresa aleatória do banco"
    
    EXEMPLOS DE RESPOSTAS:
    
    Para "Olá":
    ```
    Olá! 👋 Sou seu assistente de análise de notas fiscais eletrônicas.
    
    Posso ajudá-lo a:
    • Consultar vendas e faturamento
    • Analisar produtos e clientes
    • Verificar impostos e pagamentos
    • Gerar relatórios personalizados
    
    Por exemplo, você pode perguntar:
    "Quanto vendemos este mês?" ou "Gere uma empresa aleatória"
    
    Como posso ajudar você hoje?
    ```
    
    Para follow-up "Qual foi o nome da empresa?":
    ```
    [Buscar no contexto acima]
    
    A empresa mencionada foi [Nome encontrado no contexto].
    
    Quer ver as notas fiscais dessa empresa?
    ```
    
    Para "Obrigado":
    ```
    Por nada! 😊 Fico feliz em ajudar.
    
    Se precisar de mais análises ou tiver outras dúvidas sobre suas notas
    fiscais, estou aqui.
    
    Até logo!
    ```
  
  expected_output: >
    Resposta conversacional que:
    - Usa contexto para follow-ups
    - Mantém tom amigável e profissional
    - Fornece informações úteis e relevantes
    - Oferece exemplos práticos
    - Encoraja continuação da conversa
    - É concisa mas completa
  
  agent: conversation_specialist

fiscal_analysis:
  description: >
    ⚠️ PRIMEIRO: A pergunta "{message}" é uma pergunta FISCAL ou apenas de DADOS?
    
    Dados disponíveis: {query_results}
    
    ════════════════════════════════════════════════════════════════
    DECISÃO CRÍTICA:
    ════════════════════════════════════════════════════════════════
    
    PERGUNTAS FISCAIS (faça análise completa):
    ✓ Contém palavras: "carga tributária", "impostos", "fiscal", "crédito",
      "alíquota", "CST", "CFOP", "conformidade", "auditoria", "ST"
    ✓ Pede análise, interpretação ou orientação tributária
    ✓ Compara tributação entre períodos
    
    PERGUNTAS DE DADOS (apenas formate, SEM análise):
    ✗ "Quantas notas...", "Qual o total...", "Mostre...", "Liste..."
    ✗ Pede apenas números, listas, rankings
    ✗ Não menciona aspectos tributários
    
    ════════════════════════════════════════════════════════════════
    
    SE FOR PERGUNTA DE DADOS (maioria dos casos):
    → Apenas formate os dados de {query_results}
    → Use linguagem simples e direta
    → NÃO adicione contexto fiscal
    → NÃO dê recomendações tributárias
    → NÃO use emojis fiscais (📊, 🔍, ⚠️)
    → Seja objetivo: "Você tem X notas fiscais."
    
    SE FOR PERGUNTA FISCAL (raro):
    → Faça análise tributária completa
    → Calcule indicadores (carga, alíquotas efetivas)
    → Identifique riscos e oportunidades
    → Dê recomendações específicas
    → Use formatação profissional
    
    ════════════════════════════════════════════════════════════════
    EXEMPLOS:
    ════════════════════════════════════════════════════════════════
    
    Pergunta: "Quantas notas fiscais eu tenho?"
    Tipo: DADOS
    Resposta:
    ```
    Você possui 10 notas fiscais autorizadas.
    ```
    
    Pergunta: "Qual minha carga tributária?"
    Tipo: FISCAL
    Resposta:
    ```
    📊 CARGA TRIBUTÁRIA EFETIVA
    
    Sua carga tributária é de 23,45%.
    
    COMPOSIÇÃO:
    • ICMS: 17,00%
    • PIS: 1,65%
    • COFINS: 7,60%
    • IPI: 3,00%
    
    RECOMENDAÇÕES:
    • Verificar créditos de ICMS não aproveitados
    • Analisar benefícios fiscais disponíveis
    ```
  
  expected_output: >
    Para perguntas de DADOS: resposta direta e objetiva, sem análise fiscal.
    Para perguntas FISCAIS: análise tributária completa com recomendações.
  
  agent: fiscal_specialist
